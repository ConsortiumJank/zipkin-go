version: v1.0.0.{build}

platform: x64

clone_folder: c:\gopath\src\github.com\openzipkin\zipkin-go

environment:
  GOPATH: c:\gopath
  GO111MODULE: on
  GOFLAGS: -mod=readonly

install:
  - Write-Host "Installing RabbitMQ..." -ForegroundColor Cyan

  - Write-Host "Downloading..."
  - $exePath = "$($env:USERPROFILE)\rabbitmq-server-3.7.15.exe"
  - (New-Object Net.WebClient).DownloadFile('https://github.com/rabbitmq/rabbitmq-server/releases/download/v3.7.15/rabbitmq-server-3.7.15.exe', $exePath)

  - Write-Host "Installing..."
  - cmd /c start /wait $exePath /S

  - $rabbitPath = 'C:\Program Files (x86)\RabbitMQ Server\rabbitmq-server-3.7.15'

  - Write-Host "Installing service..."
  - Start-Process -Wait "$rabbitPath\sbin\rabbitmq-service.bat" "install"

  - Write-Host "Starting service..."
  - Start-Process -Wait "$rabbitPath\sbin\rabbitmq-service.bat" "start"

  - Get-Service "RabbitMQ"

  - Write-Host "RabbitMQ installed and started" -ForegroundColor Green

  - echo %PATH%
  - echo %GOPATH%
  - set PATH=%GOPATH%\bin;c:\go\bin;%PATH%
  - go version
  - go env

build_script:
  - go vet ./...
  - go test -v -race -cover ./...
  - go test -v -run - -bench . -benchmem ./...
